@using System.Linq.Expressions
@using Soenneker.Blazor.Extensions.EventCallback
@using Soenneker.Extensions.String

@inherits Soenneker.Quark.Element
@implements Soenneker.Quark.IValidationInput

<input type="radio" @attributes="BuildAttributes()" />

@code {
	public override string? Name { get; set; } = "Radio";

    [Parameter]
    public bool Checked { get; set; }

    [Parameter]
    public bool Disabled { get; set; }

    [Parameter]
    public string? Value { get; set; }

    [Parameter]
    public EventCallback<bool> CheckedChanged { get; set; }

    [Parameter]
    public EventCallback<ChangeEventArgs> OnChange { get; set; }

    [CascadingParameter]
    public Validation? ParentValidation { get; set; }

    [Parameter]
    public Expression<Func<bool>>? CheckedExpression { get; set; }

    public object? ValidationValue => Checked;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && ParentValidation is not null)
        {
            await ParentValidation.InitializeInput(this);

            if (CheckedExpression is not null)
                await ParentValidation.InitializeInputExpression(CheckedExpression);
        }

        await base.OnAfterRenderAsync(firstRender);
    }

    private async Task HandleChange(ChangeEventArgs e)
    {
        Checked = true;
        await CheckedChanged.InvokeIfHasDelegate(Checked);

        await OnChange.InvokeIfHasDelegate(e);

        if (ParentValidation is not null)
            await ParentValidation.NotifyInputChanged(Checked);
    }

    protected override Dictionary<string, object> BuildAttributes()
    {
        Dictionary<string, object> attributes = base.BuildAttributes();

        var baseClasses = "form-check-input";
        string? validationClass = GetValidationClass();

        if (validationClass != null)
            baseClasses = $"{baseClasses} {validationClass}";

        AppendToClassAttr(attributes, baseClasses);

        if (Checked)
            attributes["checked"] = true;

        if (Disabled)
            attributes["disabled"] = true;

        if (Value.HasContent())
            attributes["value"] = Value;

        // Keep Checked in sync when the user changes selection
        attributes["onchange"] = EventCallback.Factory.Create<ChangeEventArgs>(this, HandleChange);

        return attributes;
    }

    private string? GetValidationClass()
    {
        if (ParentValidation?.Status == ValidationStatus.Error)
            return "is-invalid";

        if (ParentValidation?.Status == ValidationStatus.Success)
            return "is-valid";

        return null;
    }

}
